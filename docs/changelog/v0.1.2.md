# Release v0.1.2

This release brings significant architectural improvements to the translation engine, including a complete XML processing overhaul, enhanced error handling, and metadata translation support. The new architecture provides better translation quality, improved robustness, and more control over the translation process.

## ‚ö†Ô∏è Breaking Changes

### API Signature Changes

The `translate()` function signature has been updated to provide more flexibility:

**v0.1.1:**
```python
def translate(
    llm: LLM,                          # Required first parameter
    source_path: Path,
    target_path: Path,
    target_language: str,
    user_prompt: str | None = None,
    max_retries: int = 5,
    max_group_tokens: int = 1200,
    on_progress: Callable[[float], None] | None = None,
) -> None:
```

**v0.1.2:**
```python
def translate(
    source_path: PathLike | str,       # Now the first parameter
    target_path: PathLike | str,       # Now the second parameter
    target_language: str,
    user_prompt: str | None = None,
    max_retries: int = 5,
    max_group_tokens: int = 1200,
    llm: LLM | None = None,            # Optional keyword parameter
    translation_llm: LLM | None = None, # NEW: Separate LLM for translation
    fill_llm: LLM | None = None,       # NEW: Separate LLM for XML filling
    on_progress: Callable[[float], None] | None = None,
    on_fill_failed: Callable[[FillFailedEvent], None] | None = None,  # NEW
) -> None:
```

**Migration Guide:**

Old code:
```python
translate(llm, source_path, target_path, "English")
```

New code (option 1 - use keyword argument):
```python
translate(source_path, target_path, "English", llm=llm)
```

New code (option 2 - use dual LLMs):
```python
translate(
    source_path,
    target_path,
    "English",
    translation_llm=translation_llm,
    fill_llm=fill_llm,
)
```

**Path Type Changes:**
- `source_path` and `target_path` now accept `PathLike | str` instead of just `Path`
- You can now pass string paths directly without wrapping in `Path()`

### Internal API Changes

**Note for advanced users:** Many internal classes and functions have been refactored or removed:
- Removed `XMLGroupContext` in favor of `XMLStreamMapper`
- Removed placeholder system in favor of XML interrupter callbacks
- Refactored segment processing with new `InlineSegment` and `BlockSegment` classes
- Hill climbing algorithm replaces previous progressive locking approach

For most users using the high-level `translate()` function, these changes are transparent.

## ‚ú® Major Features

### New: `FillFailedEvent` and Error Callback System (#93, #94)

A new error monitoring system allows you to handle translation errors programmatically:

```python
from epub_translator import FillFailedEvent

def handle_error(event: FillFailedEvent):
    print(f"Error on attempt {event.retried_count}: {event.error_message}")
    if event.over_maximum_retries:
        print("Maximum retries exceeded!")

translate(
    source_path="source.epub",
    target_path="translated.epub",
    target_language="English",
    llm=llm,
    on_fill_failed=handle_error,
)
```

The `FillFailedEvent` dataclass contains:
- `error_message: str` - Description of what went wrong
- `retried_count: int` - Current retry attempt number
- `over_maximum_retries: bool` - Whether max retries was exceeded

Related PRs:
- https://github.com/oomol-lab/epub-translator/pull/93
- https://github.com/oomol-lab/epub-translator/pull/94

### Complete Table of Contents and Metadata Translation (#90)
- **Translate EPUB metadata and table of contents**
- Added comprehensive metadata translation support including title, creator, description, and other OPF metadata fields
- Table of contents entries are now fully translated alongside chapter content
- Unified translation workflow for content, TOC, and metadata
- Related PR: https://github.com/oomol-lab/epub-translator/pull/90

### Dual-LLM Architecture (#88, #89)
- **Separate LLM instances for translation and XML filling operations**
- Independent temperature and sampling parameters for each task:
  - Translation uses higher temperature (0.8) for more creative, natural output
  - XML filling uses lower temperature (0.3) for deterministic, structure-preserving results
- Improved translation quality through task-specific optimization
- Enhanced prompt templates with better error guidance
- Related PRs:
  - https://github.com/oomol-lab/epub-translator/pull/88
  - https://github.com/oomol-lab/epub-translator/pull/89


## üèóÔ∏è Architecture Improvements

### Complete XML Processing Overhaul (#80-#87)
The translation engine has been completely rewritten with a new architecture:

- **Inline and Block Segmentation** (#80, #81): New segment-based XML processing with automatic ID tracking, validation, and comprehensive error reporting
- **Hill Climbing Algorithm** (#82, #84): Intelligent iterative XML refinement with error-weighted optimization
- **Enhanced Validation** (#83): Hierarchical error grouping, scoring, and user-facing reporting with context-aware error messages
- **Stream-Based Mapping** (#85, #86): Token-aware XML element streaming with intelligent truncation and document structure preservation
- **Code Cleanup** (#87): Removed legacy components and simplified public API

The new architecture provides:
- Better handling of complex XML structures
- More accurate preservation of document formatting
- Improved error recovery through iterative refinement
- Reduced token usage through optimized ID assignment

Related PRs:
- https://github.com/oomol-lab/epub-translator/pull/80
- https://github.com/oomol-lab/epub-translator/pull/81
- https://github.com/oomol-lab/epub-translator/pull/82
- https://github.com/oomol-lab/epub-translator/pull/83
- https://github.com/oomol-lab/epub-translator/pull/84
- https://github.com/oomol-lab/epub-translator/pull/85
- https://github.com/oomol-lab/epub-translator/pull/86
- https://github.com/oomol-lab/epub-translator/pull/87

## üêõ Bug Fixes

### Windows Path Separator Issue (#79)
- **Fixed ZIP file path handling on Windows**
- Resolved issue where Windows backslash path separators caused ZIP file read failures
- Changed path handling to use `.as_posix()` for cross-platform compatibility
- Fixes reading EPUB files on Windows systems
- Related issue: https://github.com/oomol-lab/epub-translator/issues/69
- Related PR: https://github.com/oomol-lab/epub-translator/pull/79

### Lost Paragraphs (#91)
- **Fixed bug causing paragraph loss during translation**
- Corrected control flow in stream mapper to properly handle element transitions
- Ensured all text segments are captured at element boundaries
- Related PR: https://github.com/oomol-lab/epub-translator/pull/91

### Inline Segment Processing (#92)
- **Fixed inline segment collection and ordering**
- Replaced recursive approach with stack-based aggregation for better control
- Fixed head appending from next inline segment to proper tail position
- Added `depth` property to `TextSegment` class
- Migrated tests from unittest to pytest framework
- Related PR: https://github.com/oomol-lab/epub-translator/pull/92

## üì¶ Installation

```bash
pip install epub-translator==0.1.2
```

Or upgrade from a previous version:

```bash
pip install --upgrade epub-translator
```

## Migration from v0.1.1

If you're using the `translate()` function with positional arguments, you'll need to update your code to use keyword arguments for the `llm` parameter:

```python
# Old (v0.1.1)
translate(llm, source_path, target_path, "English")

# New (v0.1.2)
translate(source_path, target_path, "English", llm=llm)
```

All other usage remains compatible.

## üôè Acknowledgments

This release represents months of architectural refinement and testing. Special thanks to everyone who reported issues, provided feedback, and contributed to making this release possible!
