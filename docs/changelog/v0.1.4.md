# Release v0.1.4

This release introduces flexible translation submission modes, allowing users to choose between single-language translation and different bilingual output formats. The new architecture also improves handling of complex EPUB structures with platform nodes support.

## ‚ö†Ô∏è Breaking Changes

### New Required Parameter: `submit`

The `translate()` function now requires a `submit` parameter to specify how translations should be inserted into the document.

**v0.1.3:**
```python
translate(
    source_path=Path("source.epub"),
    target_path=Path("translated.epub"),
    target_language=language.ENGLISH,
    llm=llm,
)
```

**v0.1.4:**
```python
from epub_translator import SubmitKind

translate(
    source_path=Path("source.epub"),
    target_path=Path("translated.epub"),
    target_language=language.ENGLISH,
    submit=SubmitKind.APPEND_BLOCK,  # NEW: Required parameter
    llm=llm,
)
```

**Migration Guide:**

Users must now explicitly specify the submission mode. For bilingual books (previous default behavior), use `SubmitKind.APPEND_BLOCK`:

```python
# Recommended for bilingual books
translate(
    source_path,
    target_path,
    language.ENGLISH,
    submit=SubmitKind.APPEND_BLOCK,
    llm=llm,
)

# For single-language translation
translate(
    source_path,
    target_path,
    language.ENGLISH,
    submit=SubmitKind.REPLACE,
    llm=llm,
)
```

## ‚ú® New Features

### Flexible Translation Submission Modes (#105)

Introduced `SubmitKind` enum with three submission modes:

- **`SubmitKind.REPLACE`**: Replace original content with translations
  - Creates single-language output
  - Useful for producing books in target language only

- **`SubmitKind.APPEND_TEXT`**: Append translations as inline text
  - Creates bilingual output with continuous text flow
  - Both languages appear in the same paragraph

- **`SubmitKind.APPEND_BLOCK`** (Recommended): Append translations as block elements
  - Creates bilingual output with clear visual separation
  - Each translation appears as a separate paragraph after the original
  - Ideal for side-by-side bilingual reading experience

**Example Usage:**

```python
from epub_translator import SubmitKind

# Bilingual book with block separation (recommended)
translate(
    source_path=Path("book.epub"),
    target_path=Path("book_bilingual.epub"),
    target_language=language.ENGLISH,
    submit=SubmitKind.APPEND_BLOCK,
    llm=llm,
)

# Single-language translation
translate(
    source_path=Path("book.epub"),
    target_path=Path("book_english.epub"),
    target_language=language.ENGLISH,
    submit=SubmitKind.REPLACE,
    llm=llm,
)
```

The new API exports `SubmitKind` from the main package:
```python
from epub_translator import SubmitKind, translate
```

Related PR: https://github.com/oomol-lab/epub-translator/pull/105

## üèóÔ∏è Architecture Improvements

### Platform Nodes Support (#105)

Enhanced XML processing to handle complex document structures where block elements are interleaved with text content:

- **Platform Structure Handling**: Properly processes non-leaf block elements with mixed content
- **Nested Node Architecture**: Introduced `_Node` dataclass to represent hierarchical text segment relationships
- **Improved Submitter Logic**: Refactored `_Submitter` class with separate handling paths for text and block submissions
  - `_submit_by_text()`: Handles complex platform structures
  - `_submit_by_block()`: Handles standard block element replacements
- **Task-Based Translation**: New `TranslationTask` generic type encapsulates elements, actions, and payloads

**Technical Details:**

The system now correctly handles EPUBs with structures like:
```html
<div>
  Some text before.
  <div>Paragraph 1.</div>
  Some text in between.
  <div>Paragraph 2.</div>
  Some text after.
</div>
```

Previously, interleaved text content between block elements could be lost or misplaced. The new platform nodes architecture preserves all text content and maintains proper reading order.

### Inline Tag Detection (#105)

- **New `inline.py` Module**: Centralized inline tag detection logic
- **Performance Optimization**: Uses `frozenset` for O(1) tag lookup
- **Standard Compliance**: Recognizes all standard HTML inline elements

### French Quote Normalization (#105)

- **Quote Unwrapping**: Added `unwrap_french_quotes()` function
- **Character Mapping**: Converts French guillemets (¬´ ¬ª, ‚Äπ ‚Ä∫) to standard quotes
- **Metadata Cleanup**: Automatically applied to translated TOC and metadata entries

Related PR: https://github.com/oomol-lab/epub-translator/pull/105

## üêõ Bug Fixes

### Preserved Non-Inline Elements in REPLACE Mode (#105)

When using `SubmitKind.REPLACE`, the system now preserves non-inline child elements (like images) that were present in the original block:

- **Smart Element Preservation**: Block-level children (images, nested divs) are retained after replacement
- **Inline Cleanup**: Only inline text elements are removed during replacement
- **Proper Positioning**: Preserved elements maintain correct document order

### Tail Text Handling (#105)

- **Accurate Tail Positioning**: Fixed tail text placement in complex node hierarchies
- **Context Preservation**: Maintains proper text flow around elements
- **Edge Case Coverage**: Comprehensive test coverage for tail text scenarios

Related PR: https://github.com/oomol-lab/epub-translator/pull/105

## üì¶ Installation

```bash
pip install epub-translator==0.1.4
```

Or upgrade from a previous version:

```bash
pip install --upgrade epub-translator
```

## Migration from v0.1.3

This release contains breaking changes. All users must update their code to add the `submit` parameter:

```python
# Old (v0.1.3) - will not work
translate(source_path, target_path, "English", llm=llm)

# New (v0.1.4) - required
translate(source_path, target_path, "English", submit=SubmitKind.APPEND_BLOCK, llm=llm)
```

For most users creating bilingual books, `SubmitKind.APPEND_BLOCK` provides the same behavior as v0.1.3.

## üß™ Testing

This release includes comprehensive test coverage for the new submission system:

- **New Test File**: `tests/test_submitter.py` with 316 new lines
- **Test Coverage**:
  - REPLACE mode behavior
  - Platform structure handling
  - Tail text positioning
  - Non-inline element preservation
  - Edge cases and complex hierarchies

## üôè Acknowledgments

Thanks to all contributors who helped improve the translation submission system and enhance support for complex EPUB structures!
